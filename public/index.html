<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8">
  <title>Speech-to-Speech Urdu IVR</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    #conversation, #log {
      text-align: left; width: 80%; margin: 20px auto; border: 1px solid #ccc;
      padding: 10px; height: 200px; overflow-y: auto;
    }
    #conversation { background: #f9f9f9; }
    #log { background: #f1f1f1; font-size: 13px; color: #444; }
    .user { color: darkblue; font-weight: bold; margin: 3px 0; }
    .assistant { color: darkgreen; font-weight: bold; margin: 3px 0; }
  </style>
</head>
<body>
  <h2>Ø§Ø±Ø¯Ùˆ Ø§Ø³Ù¾ÛŒÚ† Ù¹Ùˆ Ø§Ø³Ù¾ÛŒÚ† ÚˆÛŒÙ…Ùˆ</h2>
  <button id="start">Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚº</button>
  <button id="stop" disabled>Ø±ÙˆÚ©ÛŒÚº</button>

  <h3>ğŸ’¬ Ú¯ÙØªÚ¯Ùˆ</h3>
  <div id="conversation"></div>

  <h3>ğŸ› ï¸ Ù„Ø§Ú¯</h3>
  <div id="log"></div>

  <script>
    function log(msg) {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<div>${typeof msg === "object" ? JSON.stringify(msg) : msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function addConversation(role, text) {
      if (!text) return;
      const convDiv = document.getElementById('conversation');
      convDiv.innerHTML += `<div class="${role}">${role === "user" ? "ğŸ‘¤" : "ğŸ¤–"} ${text}</div>`;
      convDiv.scrollTop = convDiv.scrollHeight;
    }

    let pc, dc;

    async function start() {
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
      log("ğŸ”„ Starting Urdu speech-to-speech...");

      pc = new RTCPeerConnection();
      dc = pc.createDataChannel("oai-events");

      dc.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);

          // --- Capture assistant transcript ---
          if (data.type === "response.audio_transcript.done" && data.transcript) {
            addConversation("assistant", data.transcript);
          }

          // --- Capture user transcript ---
          if (data.type === "conversation.item.input_audio_transcription.completed" && data.transcript) {
            addConversation("user", data.transcript);
          }

          // --- Other events go to logs ---
          if (
            data.type !== "response.audio_transcript.done" &&
            data.type !== "conversation.item.input_audio_transcription.completed"
          ) {
            log(data);
          }
        } catch {
          log(e.data);
        }
      };

      // Get mic
      const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      // Play AI voice
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      pc.ontrack = (event) => { audioEl.srcObject = event.streams[0]; };

      // Session setup
      dc.onopen = () => {
        const sessionUpdate = {
          type: 'session.update',
          session: {
            instructions: `
                Ø¢Ù¾ Ø§ÛŒÚ© Ø¯ÙˆØ³ØªØ§Ù†Û Ø§ÙˆØ± Ù‚Ø¯Ø±ØªÛŒ Ø³ÛŒÙ„Ø² Ø§ÛŒØ¬Ù†Ù¹ ÛÛŒÚº Ø¬Ùˆ Ø±Ø¦ÛŒÙ„ Ø§Ø³Ù¹ÛŒÙ¹ Ú©Ù…Ù¾Ù†ÛŒ Ú©Û’ Ù„Ø¦Û’ Ú©Ø§Ù… Ú©Ø± Ø±ÛÛ’ ÛÛŒÚºÛ”
                Ø¢Ù¾ Ú©Ø§ Ù„ÛØ¬Û Ø®ÙˆØ´ Ø§Ø®Ù„Ø§Ù‚ Ø§ÙˆØ± Ø¯ÙˆØ³ØªØ§Ù†Û ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’ØŒ Ø¬ÛŒØ³Û’ Ø¢Ù¾ Ú©Ø³ÛŒ Ø¯ÙˆØ³Øª Ø³Û’ Ø¨Ø§Øª Ú©Ø± Ø±ÛÛ’ ÛÛŒÚºÛ”
                ÛÙ…ÛŒØ´Û Ø¨Ø§Øª Ú†ÛŒØª Ú©Ùˆ Ù†Ø±Ù… Ø§Ù†Ø¯Ø§Ø² Ù…ÛŒÚº Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚºØŒ Ú©Ø¨Ú¾ÛŒ Ø¨Ú¾ÛŒ Ø¨ÛØª Ù…Ø´ÛŒÙ†ÛŒ ÛŒØ§ Ø³Ø®Øª Ù†Û Ù„Ú¯ÛŒÚºÛ”
                Ú†Ú¾ÙˆÙ¹Û’ Ø§ÙˆØ± Ù‚Ø¯Ø±ØªÛŒ Ø¬Ù…Ù„Û’ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚºØŒ Ø¬ÛŒØ³Û’ Ø¹Ø§Ù… Ú¯ÙØªÚ¯Ùˆ Ù…ÛŒÚº ÛÙˆØªÛ’ ÛÛŒÚºÛ”
                Ø§Ú¯Ø± ØµØ§Ø±Ù Ú©Ú†Ú¾ Ú©ÛÛ’ØŒ ØªÙˆ Ú©Ø¨Ú¾ÛŒ Ú©Ø¨Ú¾ÛŒ ÛÙ„Ú©ÛŒ Ø³ÛŒ ØªØ¹Ø±ÛŒÙ Ú©Ø±ÛŒÚº ÛŒØ§ ÛÙ…Ø¯Ø±Ø¯ÛŒ Ø¬ØªØ§Ø¦ÛŒÚº (Ù…Ø«Ø§Ù„: "Ø¬ÛŒ Ø¨Ø§Ù„Ú©Ù„ØŒ ÛŒÛ Ø§Ú†Ú¾ÛŒ Ø³ÙˆÚ† ÛÛ’Û”").
                Ø¶Ø±ÙˆØ±Øª Ù¾Ú‘Ù†Û’ Ù¾Ø± Ø³ÙˆØ§Ù„ Ø¯ÛØ±Ø§Ù†Û’ ÛŒØ§ ÙˆØ¶Ø§Ø­Øª Ù…Ø§Ù†Ú¯Ù†Û’ Ù…ÛŒÚº Ø¬Ú¾Ø¬Ú© Ù†Û Ú©Ø±ÛŒÚºÛ”
                Ø¬Ø¨ Ù¾Ù„Ø§Ù¹ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù¾ÙˆÚ†Ú¾ÛŒÚºØŒ ØªÙˆ Ø¢ÛØ³ØªÛ Ø¢ÛØ³ØªÛ Ø§ÛŒÚ© Ø§ÛŒÚ© Ù‚Ø¯Ù… Ø¨Ú‘Ú¾Ø§Ø¦ÛŒÚº:
                  - Ù¾ÛÙ„Û’ Ø¹Ù„Ø§Ù‚Û’ Ú©Û’ Ø¨Ø§Ø±Û’ Ù…ÛŒÚº Ù¾ÙˆÚ†Ú¾ÛŒÚº
                  - Ù¾Ú¾Ø± Ø¨Ø¬Ù¹ Ú©Û’ Ø¨Ø§Ø±Û’ Ù…ÛŒÚº
                  - Ù¾Ú¾Ø± Ø³Ø§Ø¦Ø² (Ù…Ø±Ù„Û ÛŒØ§ Ú©Ù†Ø§Ù„) Ú©Û’ Ø¨Ø§Ø±Û’ Ù…ÛŒÚº
                  - Ù¾Ú¾Ø± Ø§Ø¶Ø§ÙÛŒ Ø³ÛÙˆÙ„ÛŒØ§Øª (Ø³Ú©ÙˆÙ„ØŒ Ù¾Ø§Ø±Ú©ØŒ Ù…Ø§Ø±Ú©ÛŒÙ¹) Ú©Û’ Ø¨Ø§Ø±Û’ Ù…ÛŒÚº
                Ø¢Ø®Ø± Ù…ÛŒÚº Ø§ÛŒÚ© Ø¯ÙˆØ³ØªØ§Ù†Û Ø§Ù†Ø¯Ø§Ø² Ù…ÛŒÚº Ø®Ù„Ø§ØµÛ Ù¾ÛŒØ´ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ù¾ÙˆÚ†Ú¾ÛŒÚº Ú©Û Ú©ÛŒØ§ ÙˆÛ Ù…Ø²ÛŒØ¯ ØªÙØµÛŒÙ„ ÛŒØ§ ÙˆØ²Ù¹ Ú†Ø§ÛØªÛ’ ÛÛŒÚºÛ”
                ÛÙ…ÛŒØ´Û ØµØ±Ù Ø§Ø±Ø¯Ùˆ Ù…ÛŒÚº Ø¬ÙˆØ§Ø¨ Ø¯ÛŒÚºÛ”
                `
,
            voice: 'alloy',
            input_audio_transcription: { model: 'whisper-1', language: 'ur' },
            output_audio_format: 'pcm16',
            turn_detection: {
              type: "server_vad",
              threshold: 0.5,
              silence_duration_ms: 200,
              create_response: true,   // âœ… Let server auto-generate
              interrupt_response: true
            }
          }
        };
        dc.send(JSON.stringify(sessionUpdate));
      };

      // Offer/Answer with backend
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const sdpResp = await fetch("http://localhost:3000/session", {
        method: "POST",
        headers: { "Content-Type": "application/sdp" },
        body: offer.sdp
      });

      const answer = { type: "answer", sdp: await sdpResp.text() };
      await pc.setRemoteDescription(answer);

      log("âœ… Connected. Ø¨ÙˆÙ„ÛŒÚº!");
    }

    async function stop() {
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      log("â¹ï¸ Stopped.");
      if (pc) {
        pc.close();
        pc = null;
      }
    }

    document.getElementById('start').onclick = start;
    document.getElementById('stop').onclick = stop;
  </script>
</body>
</html>
